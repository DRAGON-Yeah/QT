<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>子菜单收起功能测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f0f2f5;
        }
        
        .test-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 240px;
            background: #001529;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-logo {
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        .sidebar-menu-wrapper {
            position: relative;
            height: calc(100vh - 64px);
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .menu-item {
            padding: 12px 16px;
            color: rgba(255, 255, 255, 0.65);
            cursor: pointer;
            margin: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .menu-item.active {
            background-color: #1890ff;
            color: white;
        }
        
        .submenu {
            margin: 2px 8px;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .submenu-title {
            padding: 12px 16px;
            color: rgba(255, 255, 255, 0.65);
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }
        
        .submenu-title:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .submenu-arrow {
            font-size: 12px;
            transition: transform 0.3s;
        }
        
        .submenu.expanded .submenu-arrow {
            transform: rotate(180deg);
        }
        
        .submenu-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }
        
        .submenu.expanded .submenu-items {
            max-height: 300px;
        }
        
        .submenu-item {
            padding: 8px 32px;
            color: rgba(255, 255, 255, 0.65);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .submenu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .submenu-item.active {
            background-color: #1890ff;
            color: white;
        }
        
        .main-content {
            flex: 1;
            padding: 24px;
            background: white;
            margin: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .test-instruction {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #52c41a;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .test-steps {
            margin-top: 8px;
            font-size: 12px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="sidebar">
            <div class="sidebar-logo">
                QuantTrade
            </div>
            <div class="sidebar-menu-wrapper">
                <div class="menu-item active">仪表盘</div>
                
                <div class="submenu" id="tradingSubmenu">
                    <div class="submenu-title" onclick="toggleSubmenu('trading')">
                        <span>交易中心</span>
                        <span class="submenu-arrow">▼</span>
                    </div>
                    <div class="submenu-items">
                        <div class="submenu-item">现货交易</div>
                        <div class="submenu-item">订单管理</div>
                        <div class="submenu-item active">持仓管理</div>
                        <div class="submenu-item">交易历史</div>
                    </div>
                </div>
                
                <div class="submenu" id="strategySubmenu">
                    <div class="submenu-title" onclick="toggleSubmenu('strategy')">
                        <span>策略管理</span>
                        <span class="submenu-arrow">▼</span>
                    </div>
                    <div class="submenu-items">
                        <div class="submenu-item">策略列表</div>
                        <div class="submenu-item">策略回测</div>
                        <div class="submenu-item">策略监控</div>
                        <div class="submenu-item">风险控制</div>
                    </div>
                </div>
                
                <div class="submenu" id="analysisSubmenu">
                    <div class="submenu-title" onclick="toggleSubmenu('analysis')">
                        <span>数据分析</span>
                        <span class="submenu-arrow">▼</span>
                    </div>
                    <div class="submenu-items">
                        <div class="submenu-item">市场行情</div>
                        <div class="submenu-item">技术指标</div>
                        <div class="submenu-item">量化因子</div>
                        <div class="submenu-item">回测报告</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <h1>子菜单收起功能测试</h1>
            <p>当前选中：交易中心 > 持仓管理</p>
            <br>
            <p><strong>修复说明：</strong></p>
            <ul>
                <li>修复了handleOpenChange函数，确保正确处理菜单状态更新</li>
                <li>移除了useEffect中的openKeys依赖，避免无限循环</li>
                <li>改进了自动展开逻辑，不会干扰用户的手动收起操作</li>
                <li>在任何情况下点击向上箭头都能收起菜单</li>
            </ul>
            <br>
            <p><strong>核心改进：</strong></p>
            <ol>
                <li>handleOpenChange现在会检查侧边栏状态</li>
                <li>自动展开只在路径变化时触发，不受openKeys状态影响</li>
                <li>使用函数式状态更新，避免状态竞争</li>
                <li>确保用户操作优先级高于自动行为</li>
            </ol>
        </div>
    </div>
    
    <div class="test-instruction">
        <strong>测试步骤：</strong>
        <div class="test-steps">
            1. 点击"交易中心"展开子菜单<br>
            2. 选择任意子菜单项<br>
            3. 点击向上箭头收起菜单<br>
            4. 验证菜单能正确收起<br>
            5. 重复测试不同菜单组合
        </div>
    </div>
    
    <script>
        // 模拟菜单展开/收起功能
        function toggleSubmenu(menuKey) {
            const submenu = document.getElementById(menuKey + 'Submenu');
            if (submenu) {
                submenu.classList.toggle('expanded');
                
                // 模拟实际组件中的状态管理
                console.log(`菜单 ${menuKey} ${submenu.classList.contains('expanded') ? '展开' : '收起'}`);
                
                // 关闭其他子菜单（模拟单一展开行为）
                const allSubmenus = document.querySelectorAll('.submenu');
                allSubmenus.forEach(sub => {
                    if (sub !== submenu && sub.classList.contains('expanded')) {
                        sub.classList.remove('expanded');
                    }
                });
            }
        }
        
        // 页面加载时默认展开交易中心菜单（模拟当前选中状态）
        document.addEventListener('DOMContentLoaded', function() {
            const tradingSubmenu = document.getElementById('tradingSubmenu');
            if (tradingSubmenu) {
                tradingSubmenu.classList.add('expanded');
            }
        });
        
        // 为子菜单项添加点击事件
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('submenu-item')) {
                // 移除其他选中状态
                document.querySelectorAll('.submenu-item.active').forEach(item => {
                    item.classList.remove('active');
                });
                // 添加选中状态
                e.target.classList.add('active');
                
                console.log(`选中子菜单项: ${e.target.textContent}`);
            }
        });
    </script>
</body>
</html>
